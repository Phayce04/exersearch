// WorkoutWeek.jsx
import React, { useEffect, useMemo, useState } from "react";
import { createPortal } from "react-dom";
import { useNavigate, useLocation } from "react-router-dom";
import "./workoutWeek.css";
import {
  generateUserWorkoutPlan,
  getUserWorkoutPlan,
  getUserPreferences,
  saveUserPreferences,
  getUserPreferredEquipments,
  saveUserPreferredEquipments,
  getEquipments,
} from "../../utils/workoutPlanApi";

const BRAND = "#ff8c00";

const WEEK = [
  { weekday: 1, name: "Monday" },
  { weekday: 2, name: "Tuesday" },
  { weekday: 3, name: "Wednesday" },
  { weekday: 4, name: "Thursday" },
  { weekday: 5, name: "Friday" },
  { weekday: 6, name: "Saturday" },
  { weekday: 7, name: "Sunday" },
];

const GOAL_OPTIONS = ["build_muscle", "lose_fat", "strength", "endurance"];

const MUSCLE_OPTIONS = [
  "quads",
  "chest",
  "back",
  "core",
  "hamstrings",
  "shoulders",
  "triceps",
  "biceps",
  "calves",
  "legs",
  "glutes",
  "cardio",
];

/* ✅ Persist last generated plan id so back button returns to generated plan */
const LAST_PLAN_ID_KEY = "exersearch_last_user_plan_id";

function loadLastPlanId() {
  const v = localStorage.getItem(LAST_PLAN_ID_KEY);
  const n = Number(v);
  return Number.isFinite(n) && n > 0 ? n : null;
}

function saveLastPlanId(id) {
  const n = Number(id);
  if (!Number.isFinite(n) || n <= 0) return;
  localStorage.setItem(LAST_PLAN_ID_KEY, String(n));
}

function prettyLabel(s = "") {
  return String(s)
    .trim()
    .replace(/_/g, " ")
    .toLowerCase()
    .replace(/\b\w/g, (c) => c.toUpperCase());
}

function countSets(day) {
  const ex = day?.exercises || [];
  return ex.reduce((sum, e) => sum + (Number(e.sets) || 0), 0);
}

function safeNum(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

export default function WorkoutWeek() {
  const navigate = useNavigate();
  const location = useLocation();

  const [plan, setPlan] = useState(null);
  const [activePlanId, setActivePlanId] = useState(null);

  const [loadingGenerate, setLoadingGenerate] = useState(false);
  const [loadingPlan, setLoadingPlan] = useState(false);
  const [error, setError] = useState("");

  // ✅ Recalibrate modal state
  const [showPrefs, setShowPrefs] = useState(false);
  const [prefsLoading, setPrefsLoading] = useState(false);
  const [prefsSaving, setPrefsSaving] = useState(false);
  const [prefsError, setPrefsError] = useState("");

  const [prefs, setPrefs] = useState({
    goal: "",
    workout_days: 3,
    workout_level: "intermediate",
    session_minutes: 45,
    workout_place: "gym",
    preferred_style: "mixed",
    injuries: [],
  });

  const [equipmentOptions, setEquipmentOptions] = useState([]);
  const [preferredEquipmentIds, setPreferredEquipmentIds] = useState([]);

  // ✅ On first mount: restore last plan id so returning from DayDetails shows the generated plan
  useEffect(() => {
    const last = loadLastPlanId();
    if (last && !activePlanId) {
      setActivePlanId(last);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const weekDays = useMemo(() => {
    const apiDays = plan?.days || [];
    const byWeekday = new Map(apiDays.map((d) => [Number(d.weekday), d]));

    return WEEK.map((w, idx) => {
      const d = byWeekday.get(w.weekday);

      if (!d) {
        return {
          weekday: w.weekday,
          weekday_name: w.name,
          day_number: idx + 1,
          is_rest: true,
          focus: "rest",
          exercises: [],
        };
      }

      return {
        ...d,
        weekday_name: d.weekday_name || w.name,
        day_number: d.day_number ?? idx + 1,
        focus: d.focus || "workout",
        exercises: Array.isArray(d.exercises) ? d.exercises : [],
      };
    });
  }, [plan]);

  const topRow = weekDays.slice(0, 4);
  const bottomRow = weekDays.slice(4, 7);

  async function handleGenerate(overrides = {}) {
    setError("");
    setLoadingGenerate(true);

    try {
      const res = await generateUserWorkoutPlan(overrides);
      const newPlan = res?.data || null;

      if (!newPlan?.user_plan_id) {
        throw new Error("Generate succeeded but plan data is missing.");
      }

      setPlan(newPlan);
      setActivePlanId(newPlan.user_plan_id);

      // ✅ persist so when user goes back from details, they see this plan again
      saveLastPlanId(newPlan.user_plan_id);

      console.log("[WorkoutWeek] Generated plan:", newPlan);
    } catch (e) {
      console.error("[WorkoutWeek] Generate error:", e);
      setError(e?.message || "Failed to generate plan.");
    } finally {
      setLoadingGenerate(false);
    }
  }

  async function handleLoadPlan(id) {
    if (!id) return;
    setError("");
    setLoadingPlan(true);

    try {
      const res = await getUserWorkoutPlan(id);
      const loaded = res?.data || null;
      setPlan(loaded);

      // ✅ also persist the id if load works
      saveLastPlanId(id);

      console.log("[WorkoutWeek] Loaded plan:", loaded);
    } catch (e) {
      console.error("[WorkoutWeek] Load plan error:", e);
// silently ignore for first-time users
console.warn("[WorkoutWeek] No existing plan found.");
    } finally {
      setLoadingPlan(false);
    }
  }

  useEffect(() => {
    if (activePlanId) handleLoadPlan(activePlanId);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [activePlanId]);

  async function openRecalibrate() {
    setShowPrefs(true);
    setPrefsError("");
    setPrefsLoading(true);

    try {
      const [prefRes, prefEqRes, eqRes] = await Promise.all([
        getUserPreferences(),
        getUserPreferredEquipments(),
        getEquipments({ per_page: 2000 }),
      ]);

      const p = prefRes?.data || null;
      const preferredEquipments = prefEqRes?.data || [];

      const eqPayload = eqRes?.data ?? eqRes ?? [];
      const allEquipments = Array.isArray(eqPayload)
        ? eqPayload
        : Array.isArray(eqPayload?.data)
        ? eqPayload.data
        : Array.isArray(eqPayload?.items)
        ? eqPayload.items
        : [];

      setPrefs({
        goal: p?.goal ?? "",
        workout_days: Number(p?.workout_days ?? 3),
        workout_level: p?.workout_level ?? "intermediate",
        session_minutes: Number(p?.session_minutes ?? 45),
        workout_place: p?.workout_place ?? "gym",
        preferred_style: p?.preferred_style ?? "mixed",
        injuries: Array.isArray(p?.injuries) ? p.injuries : [],
      });

      setPreferredEquipmentIds(
        (preferredEquipments || [])
          .map((e) => Number(e?.equipment_id))
          .filter(Boolean)
      );

      setEquipmentOptions(allEquipments);
    } catch (e) {
      console.error("[WorkoutWeek] Pref load error:", e);
      setPrefsError(e?.message || "Failed to load preferences.");
    } finally {
      setPrefsLoading(false);
    }
  }

  async function saveAndRecalibrate() {
    setPrefsError("");
    setPrefsSaving(true);

    try {
      await saveUserPreferences({
        goal: prefs.goal || null,
        workout_days: Number(prefs.workout_days),
        workout_level: prefs.workout_level,
        session_minutes: Number(prefs.session_minutes),
        workout_place: prefs.workout_place,
        preferred_style: prefs.preferred_style || null,
        injuries: prefs.injuries || [],
      });

      await saveUserPreferredEquipments(
        preferredEquipmentIds.map(Number).filter(Boolean)
      );

      setShowPrefs(false);

      await handleGenerate({
        goal: prefs.goal || undefined,
        workout_days: Number(prefs.workout_days),
        workout_level: prefs.workout_level,
        session_minutes: Number(prefs.session_minutes),
        workout_place: prefs.workout_place,
        preferred_style: prefs.preferred_style || undefined,
        injuries: prefs.injuries || [],
      });
    } catch (e) {
      console.error("[WorkoutWeek] Save+Recalibrate error:", e);
      setPrefsError(e?.message || "Failed to save preferences.");
    } finally {
      setPrefsSaving(false);
    }
  }

  function goToDayDetails(userPlanDayId, dayObj) {
    const id = safeNum(userPlanDayId);
    const path = id ? `/home/workout/day/${id}` : "";

    const clickInfo = {
      clickedAt: new Date().toISOString(),
      from: location.pathname,
      targetIdRaw: userPlanDayId,
      targetIdParsed: id,
      computedPath: path,
      day: {
        weekday: dayObj?.weekday,
        weekday_name: dayObj?.weekday_name,
        day_number: dayObj?.day_number,
        is_rest: dayObj?.is_rest,
        focus: dayObj?.focus,
        hasExercises: (dayObj?.exercises?.length ?? 0) > 0,
      },
    };

    console.log("[WorkoutWeek] View details click:", clickInfo);

    if (!id) {
      setError("This day has no user_plan_day_id yet (cannot open details).");
      return;
    }

    if (activePlanId) saveLastPlanId(activePlanId);

    navigate(path);
  }

  const hasPlan = !!plan;

  return (
    <div className="ww" style={{ "--brand": BRAND }}>
      {!hasPlan ? (
        <section className="ww-landing">
          <div className="ww-landing-inner">
            <h1 className="ww-landing-title">
              FIND YOUR WORKOUT <br />
              PLAN
            </h1>

            <button
              className="ww-landing-btn"
              onClick={() => handleGenerate({})}
              disabled={loadingGenerate}
              type="button"
            >
              {loadingGenerate ? "Generating..." : "Generate Plan"}
            </button>

            <button
              className="ww-landing-btn ww-landing-btn-secondary"
              onClick={openRecalibrate}
              type="button"
            >
              Recalibrate Preferences
            </button>

          </div>
        </section>
      ) : (
        <div className="ww-page">
          <div className="ww-headerbar">
            <div className="ww-container">
              <header className="ww-header">
                <div className="ww-header-left">
                  <h1 className="ww-title">My Weekly Workout Plan</h1>

                  <div className="ww-meta">
                    {loadingPlan && <span className="ww-muted">Loading…</span>}

                    {plan?.template && (
                      <span className="ww-pill">
                        {prettyLabel(plan.template.goal)} •{" "}
                        {prettyLabel(plan.template.split_type)} •{" "}
                        {plan.template.days_per_week} days/week
                      </span>
                    )}

                    {plan?.start_date && (
                      <span className="ww-muted">
                        Start: <b>{new Date(plan.start_date).toDateString()}</b>
                      </span>
                    )}
                  </div>
                </div>

                <div className="ww-header-right">
                  <button
                    className="ww-btn ww-btn-ghost"
                    onClick={() => handleGenerate({})}
                    disabled={loadingGenerate}
                    type="button"
                    title="Generate a fresh plan"
                  >
                    {loadingGenerate ? "Generating..." : "Regenerate"}
                  </button>

                  <button
                    className="ww-btn"
                    onClick={openRecalibrate}
                    type="button"
                    title="Edit preferences + preferred equipment"
                    style={{ marginLeft: 10 }}
                  >
                    Recalibrate Preferences
                  </button>
                </div>
              </header>

              {error ? <div className="ww-header-error">{error}</div> : null}
            </div>
          </div>

          <div className="ww-container ww-body">
            <section className="ww-grid-wrap">
              <div className="ww-grid ww-grid-top">
                {topRow.map((day) => (
                  <DayCard
                    key={day.weekday}
                    day={day}
                    onViewDetails={(userPlanDayId) =>
                      goToDayDetails(userPlanDayId, day)
                    }
                  />
                ))}
              </div>

              <div className="ww-grid ww-grid-bottom">
                {bottomRow.map((day) => (
                  <DayCard
                    key={day.weekday}
                    day={day}
                    onViewDetails={(userPlanDayId) =>
                      goToDayDetails(userPlanDayId, day)
                    }
                  />
                ))}
              </div>
            </section>

            <footer className="ww-footer">
              <button
                className="ww-footer-btn"
                onClick={() => window.scrollTo({ top: 0, behavior: "smooth" })}
                type="button"
              >
                Exersearch
              </button>
            </footer>
          </div>
        </div>
      )}

      {showPrefs
        ? createPortal(
            <PreferencesModal
              loading={prefsLoading}
              saving={prefsSaving}
              error={prefsError}
              prefs={prefs}
              setPrefs={setPrefs}
              equipmentOptions={equipmentOptions}
              preferredEquipmentIds={preferredEquipmentIds}
              setPreferredEquipmentIds={setPreferredEquipmentIds}
              onClose={() => setShowPrefs(false)}
              onSave={saveAndRecalibrate}
            />,
            document.body
          )
        : null}
    </div>
  );
}

function DayCard({ day, onViewDetails }) {
  const isRest = !!day.is_rest || (day.exercises?.length ?? 0) === 0;
  const focusLabel = prettyLabel(isRest ? "rest" : day.focus);
  const setsTotal = countSets(day);
  const list = (day.exercises || []).slice(0, 6);

  const canView = !!day?.user_plan_day_id && !isRest;

  return (
    <article className={`ww-card ${isRest ? "is-rest" : ""}`}>
      <div className="ww-card-head">
        <div className="ww-card-headbg" />

        <div className="ww-card-top">
          <div className="ww-card-day">{day.weekday_name || "Day"}</div>

          <div className="ww-card-chip">
            <span className="ww-card-chip-num">
              {day.day_number || day.weekday}
            </span>
            <span className="ww-card-chip-label">{focusLabel}</span>
          </div>
        </div>
      </div>

      <div className="ww-card-body">
        {isRest ? (
          <ul className="ww-list">
            <li>
              <span>Recovery</span> / Mobility
            </li>
            <li>
              <span>Optional</span> Walk 20–30 min
            </li>
            <li>
              <span>Hydrate</span> + sleep
            </li>
          </ul>
        ) : (
          <ul className="ww-list">
            <li className="ww-list-strong">
              <span>{list.length}</span> Exercises shown
            </li>
            <li className="ww-list-strong">
              <span>{setsTotal}</span> Total Sets
            </li>

            <div className="ww-divider" />

            {list.map((ex) => (
              <li
                key={
                  ex.user_plan_exercise_id ||
                  ex.template_day_exercise_id ||
                  ex.exercise_id
                }
                className="ww-ex"
                title={ex.exercise?.name || ""}
              >
                <span className="ww-ex-sets">{ex.sets}×</span>
                <span className="ww-ex-name">
                  {ex.exercise?.name || `Exercise #${ex.exercise_id}`}
                </span>
              </li>
            ))}
          </ul>
        )}
      </div>

      <button
        className={`ww-btn ww-btn-card ${isRest ? "is-rest" : ""}`}
        type="button"
        disabled={!canView}
        onClick={() => {
          if (!canView) return;
          onViewDetails?.(day.user_plan_day_id);
        }}
      >
        {isRest ? "Rest Day" : "View Details"}
      </button>
    </article>
  );
}

/* ------------------------------------------------------------------
 * ✅ Preferences Modal
 * ------------------------------------------------------------------ */

function PreferencesModal({
  loading,
  saving,
  error,
  prefs,
  setPrefs,
  equipmentOptions,
  preferredEquipmentIds,
  setPreferredEquipmentIds,
  onClose,
  onSave,
}) {
  const [injuryPick, setInjuryPick] = useState("");

  function toggleEquipment(id) {
    setPreferredEquipmentIds((prev) => {
      const set = new Set(prev.map(Number));
      if (set.has(id)) set.delete(id);
      else set.add(id);
      return Array.from(set);
    });
  }

  function addInjuredMuscle() {
    const t = String(injuryPick || "").trim();
    if (!t) return;

    setPrefs((p) => {
      const cur = Array.isArray(p.injuries) ? p.injuries : [];
      const lower = cur.map((x) => String(x).toLowerCase());
      if (lower.includes(t.toLowerCase())) return p;
      return { ...p, injuries: [...cur, t] };
    });

    setInjuryPick("");
  }

  function removeInjury(tag) {
    setPrefs((p) => ({
      ...p,
      injuries: (p.injuries || []).filter(
        (x) => String(x).toLowerCase() !== String(tag).toLowerCase()
      ),
    }));
  }

  const eqList = Array.isArray(equipmentOptions) ? equipmentOptions : [];

  return (
    <div className="ww-modal-backdrop" onClick={onClose}>
      <div
        className="ww-modal"
        onClick={(e) => e.stopPropagation()}
        role="dialog"
        aria-modal="true"
      >
        <div className="ww-modal-head">
          <div>
            <div className="ww-modal-title">Recalibrate Preferences</div>
            <div className="ww-modal-sub">
              Pick your goal, injured muscles to avoid, equipment, then regenerate.
            </div>
          </div>

          <button className="ww-btn ww-btn-ghost" onClick={onClose} type="button">
            Close
          </button>
        </div>

        {loading ? (
          <div className="ww-modal-loading">Loading…</div>
        ) : (
          <>
            {error ? <div className="ww-modal-error">{error}</div> : null}

            <div className="ww-modal-grid">
              <label className="ww-field">
                <span>Goal</span>
                <select
                  value={prefs.goal || ""}
                  onChange={(e) => setPrefs((p) => ({ ...p, goal: e.target.value }))}
                >
                  <option value="" disabled>
                    Select a goal…
                  </option>
                  {GOAL_OPTIONS.map((g) => (
                    <option key={g} value={g}>
                      {prettyLabel(g)}
                    </option>
                  ))}
                </select>
              </label>

              <label className="ww-field">
                <span>Days / week</span>
                <input
                  type="number"
                  min="1"
                  max="7"
                  value={prefs.workout_days ?? 3}
                  onChange={(e) =>
                    setPrefs((p) => ({
                      ...p,
                      workout_days: Number(e.target.value),
                    }))
                  }
                />
              </label>

              <label className="ww-field">
                <span>Level</span>
                <select
                  value={prefs.workout_level || "intermediate"}
                  onChange={(e) =>
                    setPrefs((p) => ({ ...p, workout_level: e.target.value }))
                  }
                >
                  <option value="beginner">Beginner</option>
                  <option value="intermediate">Intermediate</option>
                  <option value="advanced">Advanced</option>
                </select>
              </label>

              <label className="ww-field">
                <span>Session minutes</span>
                <input
                  type="number"
                  min="10"
                  max="240"
                  value={prefs.session_minutes ?? 45}
                  onChange={(e) =>
                    setPrefs((p) => ({
                      ...p,
                      session_minutes: Number(e.target.value),
                    }))
                  }
                />
              </label>

              <label className="ww-field">
                <span>Workout place</span>
                <select
                  value={prefs.workout_place || "gym"}
                  onChange={(e) =>
                    setPrefs((p) => ({ ...p, workout_place: e.target.value }))
                  }
                >
                  <option value="home">Home</option>
                  <option value="gym">Gym</option>
                  <option value="both">Both</option>
                </select>
              </label>

              <label className="ww-field">
                <span>Preferred style</span>
                <select
                  value={prefs.preferred_style || "mixed"}
                  onChange={(e) =>
                    setPrefs((p) => ({ ...p, preferred_style: e.target.value }))
                  }
                >
                  <option value="strength">Strength</option>
                  <option value="hypertrophy">Hypertrophy</option>
                  <option value="endurance">Endurance</option>
                  <option value="hiit">HIIT</option>
                  <option value="mixed">Mixed</option>
                </select>
              </label>

              <div className="ww-field ww-field-wide">
                <span>Injured Muscles (will be avoided)</span>

                <div className="ww-tags">
                  {(prefs.injuries || []).map((t) => (
                    <span key={String(t)} className="ww-tag">
                      {prettyLabel(t)}
                      <button type="button" onClick={() => removeInjury(t)}>
                        ×
                      </button>
                    </span>
                  ))}
                </div>

                <div className="ww-tag-row">
                  <select
                    value={injuryPick}
                    onChange={(e) => setInjuryPick(e.target.value)}
                  >
                    <option value="">Select a muscle…</option>
                    {MUSCLE_OPTIONS.map((m) => (
                      <option key={m} value={m}>
                        {prettyLabel(m)}
                      </option>
                    ))}
                  </select>

                  <button
                    className="ww-btn ww-btn-ghost"
                    type="button"
                    onClick={addInjuredMuscle}
                    disabled={!injuryPick}
                  >
                    Add
                  </button>
                </div>

                <div className="ww-muted" style={{ color: "#6b7280", marginTop: 8 }}>
                  Example: If you add “Back”, exercises with primary muscle “back”
                  will be filtered out during generation.
                </div>
              </div>
            </div>

            <div className="ww-modal-section">
              <div className="ww-modal-section-title">Preferred Equipment</div>

              <div className="ww-eq-grid">
                {eqList.map((e) => {
                  const id = Number(e?.equipment_id);
                  if (!id) return null;

                  const name = e?.name || `Equipment #${id}`;
                  const checked = preferredEquipmentIds.map(Number).includes(id);

                  return (
                    <button
                      key={id}
                      type="button"
                      className={`ww-eq-pill ${checked ? "is-on" : ""}`}
                      onClick={() => toggleEquipment(id)}
                      title={name}
                    >
                      {checked ? "✓ " : ""}
                      {prettyLabel(name)}
                    </button>
                  );
                })}
              </div>
            </div>

            <div className="ww-modal-actions">
              <button
                className="ww-btn ww-btn-ghost"
                onClick={onClose}
                type="button"
                disabled={saving}
              >
                Cancel
              </button>

              <button className="ww-btn" onClick={onSave} type="button" disabled={saving}>
                {saving ? "Saving…" : "Save & Recalibrate"}
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}
